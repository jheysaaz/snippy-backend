name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.9"

      - name: Build
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o snippy-api .

      - name: Copy binary to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: "snippy-api"
          target: "/root/snippy-api/"
          overwrite: true
          overwrite: true

      - name: Copy systemd service file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: "snippy-api.service"
          target: "/root/snippy-api/"
          overwrite: true

      - name: Copy docker-compose file
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/root/snippy-api/"
          overwrite: true

      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USERNAME }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd /root/snippy-api
            
            # Make binary executable
            chmod +x snippy-api
            
            # Install systemd service if it doesn't exist
            if [ ! -f /etc/systemd/system/snippy-api.service ]; then
              cp snippy-api.service /etc/systemd/system/
              systemctl daemon-reload
              systemctl enable snippy-api
            fi
            
            # Restart service (this runs docker-compose)
            systemctl restart snippy-api
            
            # Wait for services to start
            sleep 10
            
            # Check status
            systemctl status snippy-api --no-pager
            docker-compose ps
            
            # Health check
            if curl -f http://localhost:8080/api/v1/health; then
              echo "✅ Deploy successful"
            else
              echo "❌ Health check failed"
              docker-compose logs --tail=50 api
              exit 1
            fi
